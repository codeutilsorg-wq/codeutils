<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CRITICAL: Apply theme immediately to prevent flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('codeutils-theme');
            if (theme === 'light') {
                document.documentElement.classList.add('light-mode');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator | Create Custom QR Codes with Logo & Gradients - Code Utils</title>
    <meta name="description" content="Professional QR code generator with logo upload, gradients, vector downloads (SVG/PDF). Create vCard, WiFi, Email, SMS QR codes. Customizable colors, patterns, shapes. 100% free & private. No registration required.">
    <meta name="keywords" content="qr code generator, qr code maker, custom qr code, qr code with logo, vcard qr code, wifi qr code, qr code svg, qr code pdf, gradient qr code">
    <link rel="canonical" href="https://codeutils.org/qr-generator">

    <!-- Favicon and Touch Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#3498db">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://codeutils.org/qr-generator">
    <meta property="og:title" content="Professional QR Code Generator - Custom QR Codes with Logo & Gradients">
    <meta property="og:description" content="Create professional QR codes with logo upload, gradients, and vector downloads. Support for vCard, WiFi, Email, SMS. Fully customizable colors, patterns, and shapes. 100% free.">
    <meta property="og:image" content="https://codeutils.org/images/og/qr-generator.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="QR Code Generator with Logo and Gradients - Free Professional Tool">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Professional QR Code Generator - Custom QR Codes with Logo & Gradients">
    <meta name="twitter:description" content="Create custom QR codes with logo upload, gradients, vector downloads (SVG/PDF). vCard, WiFi, Email, SMS support. 100% free & private.">
    <meta name="twitter:image" content="https://codeutils.org/images/og/qr-generator.png">

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://www.googletagmanager.com">
    <link rel="dns-prefetch" href="https://www.googletagmanager.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RPHPBJ4291"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-RPHPBJ4291');
    </script>

    <!-- Structured Data: WebApplication Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "QR Code Generator - Code Utils",
      "applicationCategory": "DeveloperApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "Professional QR code generator with logo upload, gradients, vector downloads (SVG/PDF/PNG). Create vCard, WiFi, Email, SMS QR codes. Customizable colors, patterns, shapes, and error correction. 100% free client-side processing.",
      "url": "https://codeutils.org/qr-generator",
      "browserRequirements": "Requires JavaScript. Requires HTML5.",
      "softwareVersion": "2.0",
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "ratingCount": "820"
      }
    }
    </script>

    <!-- Structured Data: FAQ Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What error correction levels are available for QR codes?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "QR codes support four error correction levels: L (7% recovery), M (15% recovery), Q (25% recovery), H (30% recovery). Higher levels can restore more data if the QR code is damaged, faded, or partially obscured, but require more space and are harder to scan. This tool uses Level M (15%) which balances data capacity with robustness for most applications. Choose L for clean, controlled environments. Choose H for outdoor or high-wear applications."
          }
        },
        {
          "@type": "Question",
          "name": "How much data can a QR code hold?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "QR code capacity depends on version and error correction level. Maximum capacity is ~4,296 alphanumeric characters for numeric data. URLs typically hold 2,000-3,000 characters depending on error correction. QR codes automatically scale to fit data (more data = larger code). Version 1 is smallest, Version 40 is largest (177x177 modules). This tool auto-scales based on content length."
          }
        },
        {
          "@type": "Question",
          "name": "What's the difference between different QR code versions?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "QR versions (1-40) determine physical size and data capacity. Version 1 is 21x21 modules minimum; Version 40 is 177x177 modules maximum. Higher versions hold more data but create larger codes. Version 1 holds ~41 bytes, Version 40 holds ~4,296 bytes. Scanning speed increases with Version. This tool auto-selects version based on content‚Äîyou don't need to manually choose."
          }
        },
        {
          "@type": "Question",
          "name": "Does QR code size matter for scanning?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Larger QR codes are easier to scan and more forgiving of damage or poor camera quality. Print at least 2cm x 2cm for reliable scanning. Very small codes (&lt;1cm) may fail with smartphone cameras. Screen display requires at least 100x100 pixels. This tool lets you choose sizes (128x128 to 512x512 pixels). Adjust based on usage‚Äîlarger for outdoor or distance scanning, smaller for tight spaces."
          }
        },
        {
          "@type": "Question",
          "name": "QR codes vs barcodes: what's the difference?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Barcodes (1D) store data in vertical lines and hold limited information (~20 characters). QR codes (2D) store data in a grid and hold vastly more information (4,000+ characters). QR codes work at angles while barcodes need to be straight. QR codes provide error correction; barcodes don't. QR codes are cheaper to produce and scan with smartphones. Use barcodes for simple product IDs; use QR codes for complex data, URLs, or WiFi credentials."
          }
        },
        {
          "@type": "Question",
          "name": "Can I customize QR code colors and styling?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "This tool lets you customize foreground (code) and background colors. Keep high contrast for reliable scanning‚Äîavoid light colors on light backgrounds. Black on white is most reliable but any high-contrast combination works. Avoid patterns or gradients which confuse scanners. Never modify the timing patterns (alternating lines). Logo overlays should be minimal and placed carefully."
          }
        }
      ]
    }
    </script>

    <link rel="stylesheet" href="css/common.css">
    <script defer src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
        /* QR Generator specific styles */

        /* Override default .editor height for QR generator */
        .editor {
            width: 100%; /* Auto-adjust to container width */
            min-height: 80px; /* Override 400px from common.css */
            max-height: 400px;
            resize: vertical;
        }

        /* Smaller textareas for optional fields */
        .editor-small {
            min-height: 60px;
            max-height: 300px;
        }

        /* Standard form element styling */
        input[type="text"], input[type="email"], input[type="tel"],
        input[type="url"], input[type="number"], input[type="date"],
        input[type="datetime-local"] {
            width: 100%;
            padding: var(--spacing-xs);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-white);
            color: var(--text-primary);
            font-size: var(--font-md);
            line-height: 1.5;
        }

        /* Select dropdowns - theme-aware colors */
        select {
            width: 100%;
            padding: var(--spacing-xs);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: var(--font-md);
            line-height: 1.5;
            background: var(--bg-white);
            color: var(--text-primary);
        }

        /* Dropdown options - inherit theme colors */
        select option {
            background: var(--bg-white);
            color: var(--text-primary);
        }

        select:focus, input:focus, textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Card sections styling */
        .card h3 {
            color: var(--text-primary);
            margin: 0 0 var(--spacing-md) 0;
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Collapsible details styling */
        details.card > summary {
            list-style: none;
            cursor: pointer;
            user-select: none;
            font-weight: 600;
            color: var(--text-primary);
            padding: var(--spacing-md);
            margin: calc(var(--spacing-md) * -1);
            margin-bottom: var(--spacing-md);
            border-radius: var(--radius);
        }

        details.card > summary::-webkit-details-marker {
            display: none;
        }

        details.card > summary::before {
            content: '‚ñ∂';
            display: inline-block;
            margin-right: 8px;
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }

        details.card[open] > summary::before {
            transform: rotate(90deg);
        }

        details.card > summary:hover {
            background: var(--bg-secondary);
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-md);
        }
        .qr-display {
            background: white;
            padding: 24px;
            border-radius: 16px;
            display: inline-block;
            box-shadow:
                0 10px 40px rgba(0, 0, 0, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.06);
            border: 3px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        .qr-display:hover {
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateY(-4px);
        }
        #qrcode {
            width: 256px;
            height: 256px;
            display: block;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            width: 100%;
        }
        .option-group {
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        .option-group:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        .option-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        .option-group input, .option-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        .option-group input:focus, .option-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .qr-placeholder {
            width: 256px;
            height: 256px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: var(--font-sm);
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            background: var(--bg-secondary);
        }
        .qr-placeholder.hidden {
            display: none;
        }
        #qrcode.hidden {
            display: none;
        }
        #logoSizeValue {
            display: inline-block;
            margin-left: var(--spacing-xs);
            font-weight: bold;
            min-width: 40px;
        }
        #logoSize {
            width: calc(100% - 50px);
        }

        /* Keyboard Shortcuts & Accessibility */
        kbd {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.875em;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .keyboard-hints {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Enhanced focus styles for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        a:focus-visible,
        details > summary:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
        }

        /* Preset Swatches - Enhanced */
        .preset-swatch {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            position: relative;
            overflow: hidden;
        }

        .preset-swatch::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
        }

        .preset-swatch:hover {
            transform: scale(1.15) translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
            z-index: 10;
        }

        .preset-swatch:active {
            transform: scale(1.05);
        }

        .preset-swatch:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 3px;
            box-shadow: 0 0 0 6px rgba(102, 126, 234, 0.2);
        }

        .preset-more {
            font-weight: 700;
            color: var(--primary);
            border-style: dashed;
        }

        .preset-more:hover {
            background: var(--primary-light) !important;
        }

        /* Logo Upload Card */
        .logo-upload-card {
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-radius: var(--radius);
            border: 2px dashed var(--border);
            text-align: center;
        }

        .logo-preview-container {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--spacing-sm);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .logo-preview-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .upload-placeholder {
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: center;
            padding: var(--spacing-sm);
        }

        /* Validation Status Card */
        .validation-status-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .validation-row {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin: 4px 0;
            font-size: 0.875rem;
            flex-wrap: wrap;
        }

        .validation-row > span {
            flex: 1;
            min-width: 150px;
        }

        /* Download Toolbar */
        .download-toolbar {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .download-actions {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .options-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: var(--spacing-md);
            }

            #qrcode {
                max-width: 100%;
                height: auto;
            }

            .preset-swatch {
                width: 45px;
                height: 45px;
            }

            .validation-row {
                flex-direction: column;
                gap: 4px;
            }

            .validation-row > span {
                min-width: 0;
            }

            /* Download toolbar stacks on mobile */
            .download-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .download-toolbar > div {
                width: 100%;
            }

            .download-actions {
                flex-direction: column;
            }

            .download-actions .btn {
                width: 100%;
                justify-content: center;
            }

            /* Larger touch targets on mobile */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
            }

            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="url"],
            input[type="number"],
            select,
            textarea {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .preset-swatch {
                width: 40px;
                height: 40px;
            }

            .card {
                padding: var(--spacing-sm);
            }

            h3 {
                font-size: 1rem;
            }
        }

    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="index.html" class="header-logo">
                <h1>Code Utils</h1>
            </a>
            <nav class="header-nav">
                <a href="index.html" class="btn btn-outline btn-sm">All Tools</a>
                <button class="theme-toggle" onclick="CodeUtils.Theme.toggle()">Toggle Dark Mode</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="card" style="margin-bottom: var(--spacing-md); padding: var(--spacing-md);">
            <h2 style="margin-bottom: var(--spacing-xs); color: var(--primary);">QR Code Generator</h2>
            <p style="margin: 0; color: var(--text-secondary);">Create professional QR codes in seconds. Support for vCard, WiFi, Email, URLs, and more. 100% private - all processing in your browser.</p>
        </div>

        <!-- Mode Toggle -->
        <div class="card" style="margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--bg-secondary); border: 2px solid var(--border);">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-md); flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <strong style="color: var(--text-primary);">Mode:</strong>
                    <div style="display: flex; gap: var(--spacing-xs); background: var(--bg-white); border-radius: var(--radius); padding: 4px; border: 1px solid var(--border);">
                        <button id="simpleModeBtn" class="btn btn-sm" onclick="setMode('simple')" style="padding: 6px 16px; font-size: 0.875rem; min-height: auto;">
                            ‚ö° Simple
                        </button>
                        <button id="advancedModeBtn" class="btn btn-sm btn-outline" onclick="setMode('advanced')" style="padding: 6px 16px; font-size: 0.875rem; min-height: auto;">
                            ‚öôÔ∏è Advanced
                        </button>
                    </div>
                </div>
                <small id="modeDescription" style="color: var(--text-secondary); flex: 1; min-width: 200px;">
                    Simple mode: Just enter content and generate. Advanced mode: Full customization options.
                </small>
            </div>
        </div>

        <div class="card">
            <h3 id="qrTypeHeading" style="margin-bottom: var(--spacing-md); font-size: 20px; font-weight: 700;">QR Code Type</h3>
            <div class="option-group">
                <label for="qrType">What do you want to encode?</label>
                <select id="qrType" onchange="toggleQRTypeInputs()"
                        aria-labelledby="qrTypeHeading"
                        aria-describedby="qrTypeHint"
                        style="width: 100%;">
                    <option value="text">üîó Text / URL</option>
                    <option value="vcard">üë§ vCard (Contact)</option>
                    <option value="wifi">üì∂ WiFi Network</option>
                    <option value="email">‚úâÔ∏è Email</option>
                    <option value="sms">üí¨ SMS</option>
                    <option value="phone">üìû Phone / Call</option>
                    <option value="event">üìÖ Event / Calendar</option>
                    <option value="location">üìç Location / Maps</option>
                </select>
                <small id="qrTypeHint" class="sr-only">Choose the type of information you want to encode in your QR code</small>
            </div>

            <!-- Example Buttons -->
            <div style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius); border: 1px dashed var(--border);">
                <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
                    <strong style="color: var(--text-primary); font-size: 0.875rem;">üí° Try Example:</strong>
                </div>
                <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
                    <button class="btn btn-outline btn-sm" onclick="loadExample('url')" style="font-size: 0.875rem;">üîó URL</button>
                    <button class="btn btn-outline btn-sm" onclick="loadExample('vcard')" style="font-size: 0.875rem;">üë§ vCard</button>
                    <button class="btn btn-outline btn-sm" onclick="loadExample('wifi')" style="font-size: 0.875rem;">üì∂ WiFi</button>
                    <button class="btn btn-outline btn-sm" onclick="loadExample('email')" style="font-size: 0.875rem;">‚úâÔ∏è Email</button>
                </div>
            </div>
        </div>

        <!-- Text/URL Input -->
        <div id="textInput" class="card">
            <h3 id="contentHeading" style="margin-bottom: var(--spacing-md);">Content</h3>
            <div class="editor-header">
                <label for="contentInput">Content</label>
            </div>
            <textarea id="contentInput" class="editor"
                      aria-labelledby="contentHeading"
                      aria-describedby="contentHint validationStatus"
                      placeholder="Enter text, URL, or data..."
                      oninput="validateInput()">https://codeutils.org</textarea>
            <small id="contentHint" class="sr-only">Enter the text, URL, or data you want to encode in the QR code. Maximum 4,296 characters.</small>
            <div id="validationStatus" style="margin-top: var(--spacing-xs); font-size: 0.875rem; display: flex; gap: var(--spacing-md); flex-wrap: wrap;"></div>
        </div>

        <!-- vCard Input -->
        <div id="vcardInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">Contact Information</h3>
            <div class="editor-header">Contact Information</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>Full Name *</label>
                    <input type="text" id="vcardName" placeholder="John Doe">
                </div>
                <div class="option-group">
                    <label>Phone</label>
                    <input type="tel" id="vcardPhone" placeholder="+1234567890">
                </div>
                <div class="option-group">
                    <label>Email</label>
                    <input type="email" id="vcardEmail" placeholder="john@example.com">
                </div>
                <div class="option-group">
                    <label>Organization</label>
                    <input type="text" id="vcardOrg" placeholder="Company Name">
                </div>
                <div class="option-group">
                    <label>Job Title</label>
                    <input type="text" id="vcardTitle" placeholder="CEO">
                </div>
                <div class="option-group">
                    <label>Website</label>
                    <input type="url" id="vcardUrl" placeholder="https://example.com">
                </div>
            </div>
        </div>

        <!-- WiFi Input -->
        <div id="wifiInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">WiFi Network</h3>
            <div class="editor-header">WiFi Network</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>Network Name (SSID) *</label>
                    <input type="text" id="wifiSSID" placeholder="MyWiFi">
                </div>
                <div class="option-group">
                    <label>Password</label>
                    <input type="text" id="wifiPassword" placeholder="password123">
                </div>
                <div class="option-group">
                    <label>Encryption</label>
                    <select id="wifiEncryption">
                        <option value="WPA">WPA/WPA2</option>
                        <option value="WEP">WEP</option>
                        <option value="nopass">None (Open)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Hidden Network</label>
                    <input type="checkbox" id="wifiHidden">
                </div>
            </div>
        </div>

        <!-- Email Input -->
        <div id="emailInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">Email Details</h3>
            <div class="editor-header">Email</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>To (Email Address) *</label>
                    <input type="email" id="emailTo" name="email" autocomplete="email" placeholder="recipient@example.com">
                </div>
                <div class="option-group">
                    <label>Subject</label>
                    <input type="text" id="emailSubject" name="subject" autocomplete="off" placeholder="Subject">
                </div>
            </div>
            <textarea id="emailBody" class="editor editor-small" style="margin-top: var(--spacing-sm);" placeholder="Email body (optional)..."></textarea>
        </div>

        <!-- SMS Input -->
        <div id="smsInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">SMS Message</h3>
            <div class="editor-header">SMS</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="smsPhone" placeholder="+1234567890">
                </div>
            </div>
            <textarea id="smsMessage" class="editor editor-small" style="margin-top: var(--spacing-sm);" placeholder="Message text (optional)..."></textarea>
        </div>

        <!-- Phone Input -->
        <div id="phoneInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">Phone Number</h3>
            <div class="editor-header">Phone / Call</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>Phone Number *</label>
                    <input type="tel" id="phoneNumber" placeholder="+1234567890">
                </div>
            </div>
        </div>

        <!-- Event Input -->
        <div id="eventInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">Event Details</h3>
            <div class="editor-header">Event / Calendar</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>Event Name *</label>
                    <input type="text" id="eventName" placeholder="Team Meeting">
                </div>
                <div class="option-group">
                    <label>Start Date/Time *</label>
                    <input type="datetime-local" id="eventStart">
                </div>
                <div class="option-group">
                    <label>End Date/Time</label>
                    <input type="datetime-local" id="eventEnd">
                </div>
                <div class="option-group">
                    <label>Location</label>
                    <input type="text" id="eventLocation" placeholder="Conference Room A">
                </div>
            </div>
            <textarea id="eventDescription" class="editor editor-small" style="margin-top: var(--spacing-sm);" placeholder="Event description (optional)..."></textarea>
        </div>

        <!-- Location Input -->
        <div id="locationInput" class="card" style="display: none;">
            <h3 style="margin-bottom: var(--spacing-md);">Location</h3>
            <div class="editor-header">Location / Maps</div>
            <div class="options-grid">
                <div class="option-group">
                    <label>Latitude *</label>
                    <input type="number" id="locationLat" step="any" placeholder="37.7749">
                </div>
                <div class="option-group">
                    <label>Longitude *</label>
                    <input type="number" id="locationLng" step="any" placeholder="-122.4194">
                </div>
                <div class="option-group" style="grid-column: 1 / -1;">
                    <label>Or Address</label>
                    <input type="text" id="locationAddress" placeholder="123 Main St, City, State">
                    <small style="display: block; margin-top: 4px; color: var(--text-secondary);">Note: Address will be converted to Google Maps URL</small>
                </div>
            </div>
        </div>

        <details class="card" id="customizationPanel">
            <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-bottom: var(--spacing-md); padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius); user-select: none;">
                ‚öôÔ∏è Customize Appearance (Optional - Click to collapse)
            </summary>

            <!-- Color Presets - Visual Swatches -->
            <div style="margin-bottom: var(--spacing-md); padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--radius); border: 2px solid var(--primary);">
                <label style="font-weight: bold; font-size: 1rem; display: block; margin-bottom: var(--spacing-sm);">üé® Quick Color Presets</label>

                <!-- Visual Swatches - Top 8 Most Popular -->
                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: var(--spacing-sm);">
                    <button class="preset-swatch" onclick="applyPresetDirect('classic')"
                            style="background: linear-gradient(135deg, #000000 50%, #ffffff 50%);"
                            title="Classic Black & White" aria-label="Apply classic black and white preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('sunset')"
                            style="background: linear-gradient(135deg, #ff6b35, #f7931e);"
                            title="Sunset Gradient" aria-label="Apply sunset gradient preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('ocean')"
                            style="background: linear-gradient(135deg, #0077be, #00b4d8);"
                            title="Ocean Blue" aria-label="Apply ocean blue preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('berry')"
                            style="background: linear-gradient(135deg, #7209b7, #f72585);"
                            title="Berry Purple" aria-label="Apply berry purple preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('forest')"
                            style="background: linear-gradient(135deg, #2d6a4f, #52b788);"
                            title="Forest Green" aria-label="Apply forest green preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('instagram')"
                            style="background: linear-gradient(135deg, #e4405f, #f77737);"
                            title="Instagram Gradient" aria-label="Apply Instagram gradient preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('facebook')"
                            style="background: linear-gradient(135deg, #1877f2, #ffffff);"
                            title="Facebook Blue" aria-label="Apply Facebook blue preset">
                    </button>
                    <button class="preset-swatch" onclick="applyPresetDirect('inverse')"
                            style="background: linear-gradient(135deg, #ffffff 50%, #000000 50%);"
                            title="White on Black (High Contrast)" aria-label="Apply white on black preset">
                    </button>
                    <button class="preset-swatch preset-more" onclick="showAllPresets()"
                            style="background: var(--bg-primary); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; color: var(--text-secondary);"
                            title="View all 29 presets" aria-label="Show all color presets">
                        +21<br>more
                    </button>
                </div>

                <!-- All Presets Dropdown (Initially Hidden) -->
                <div id="allPresetsDropdown" style="display: none; margin-top: var(--spacing-sm);">
                    <select id="colorPreset" onchange="applyColorPreset()">
                        <option value="">-- Select from All Presets --</option>
                        <optgroup label="Professional">
                            <option value="classic">Classic Black & White</option>
                            <option value="navy">Navy Blue & White</option>
                            <option value="corporate">Corporate Blue & Gray</option>
                            <option value="elegant">Elegant Dark Gray & White</option>
                            <option value="professional">Professional Charcoal & Cream</option>
                        </optgroup>
                        <optgroup label="Vibrant">
                            <option value="sunset">Sunset Orange & Yellow</option>
                            <option value="ocean">Ocean Blue & Teal</option>
                            <option value="forest">Forest Green & Lime</option>
                            <option value="berry">Berry Purple & Pink</option>
                            <option value="fire">Fire Red & Orange</option>
                            <option value="neon">Neon Pink & Blue</option>
                        </optgroup>
                        <optgroup label="Pastel">
                            <option value="soft-pink">Soft Pink & White</option>
                            <option value="mint">Mint Green & Cream</option>
                            <option value="lavender">Lavender & Light Purple</option>
                            <option value="peach">Peach & Coral</option>
                            <option value="sky">Sky Blue & Light Blue</option>
                        </optgroup>
                        <optgroup label="High Contrast">
                            <option value="inverse">White on Black</option>
                            <option value="yellow-black">Yellow & Black</option>
                            <option value="cyan-dark">Cyan & Dark Blue</option>
                            <option value="lime-dark">Lime & Dark Green</option>
                            <option value="magenta-dark">Magenta & Dark Purple</option>
                        </optgroup>
                        <optgroup label="Brand Colors">
                            <option value="facebook">Facebook Blue</option>
                            <option value="instagram">Instagram Gradient</option>
                            <option value="twitter">Twitter Blue</option>
                            <option value="linkedin">LinkedIn Blue</option>
                            <option value="youtube">YouTube Red</option>
                        </optgroup>
                    </select>
                    <button class="btn btn-outline btn-sm" onclick="hideAllPresets()" style="margin-top: var(--spacing-xs); font-size: 0.875rem;">Hide Full List</button>
                </div>

                <small style="display: block; margin-top: var(--spacing-xs); color: var(--text-secondary);">
                    üí° Click a swatch for instant styling, or customize colors manually below
                </small>
            </div>

            <div class="options-grid">
                <div class="option-group">
                    <label>Size</label>
                    <select id="sizeSelect">
                        <option value="128">128x128</option>
                        <option value="256" selected>256x256</option>
                        <option value="512">512x512</option>
                        <option value="1024">1024x1024</option>
                        <option value="2048">2048x2048</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Error Correction</label>
                    <select id="errorCorrection" title="Higher levels recover more data if QR code is damaged">
                        <option value="L">L - Low (7%)</option>
                        <option value="M" selected>M - Medium (15%)</option>
                        <option value="Q">Q - Quartile (25%)</option>
                        <option value="H">H - High (30%)</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Color Type</label>
                    <select id="colorType" onchange="toggleGradientControls()">
                        <option value="solid" selected>Solid Color</option>
                        <option value="linear">Linear Gradient</option>
                        <option value="radial">Radial Gradient</option>
                    </select>
                </div>
                <div class="option-group">
                    <label>Foreground</label>
                    <input type="color" id="fgColor" value="#000000" onchange="checkContrast()">
                </div>
                <div class="option-group" id="fgColor2Group" style="display: none;">
                    <label>Gradient Color 2</label>
                    <input type="color" id="fgColor2" value="#3498db">
                </div>
                <div class="option-group">
                    <label>Background</label>
                    <input type="color" id="bgColor" value="#ffffff" onchange="checkContrast()">
                </div>
                <div class="option-group" style="grid-column: 1 / -1;">
                    <div id="contrastIndicator" style="padding: var(--spacing-xs); border-radius: var(--radius); font-size: 0.875rem;"></div>
                </div>
            </div>

            <!-- Module Style & Logo Upload - Side by Side -->
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-md); margin-top: var(--spacing-md);">
                <!-- Module Style -->
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: var(--spacing-sm);">üé® Module Style</label>
                    <select id="moduleStyle" style="width: 100%;">
                        <option value="square" selected>Squares</option>
                        <option value="dots">Dots (Circles)</option>
                        <option value="rounded">Rounded Squares</option>
                    </select>
                </div>

                <!-- Logo Upload with Preview -->
                <div class="logo-upload-card" style="margin-top: 0;">
                <label style="font-weight: bold; display: block; margin-bottom: var(--spacing-sm);">üì∏ Logo Overlay (Optional)</label>

                <div class="logo-preview-container" id="logoPreviewContainer">
                    <img id="logoPreview" src="" alt="Logo preview" style="display: none;">
                    <div id="logoPlaceholder" class="upload-placeholder">
                        Click "Choose Logo" below<br>
                        <small>PNG, JPG, SVG up to 2MB</small>
                    </div>
                </div>

                <input type="file" id="logoUpload" accept="image/*" onchange="handleLogoUpload(event)" hidden>

                <div style="display: flex; gap: var(--spacing-sm); justify-content: center; margin-bottom: var(--spacing-sm);">
                    <label for="logoUpload" class="btn btn-secondary" style="cursor: pointer;">Choose Logo</label>
                    <button class="btn btn-outline" onclick="clearLogo()" id="clearLogoBtn" style="display: none;">Remove</button>
                </div>

                <!-- Logo Size Control (shown only when logo loaded) -->
                <div id="logoSizeControl" style="display: none;">
                    <label style="display: block; margin-bottom: var(--spacing-xs);">
                        Logo Size: <strong><span id="logoSizeValue">20%</span></strong>
                    </label>
                    <input type="range" id="logoSize" min="10" max="40" value="20" step="5" style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                        <span>Smaller</span>
                        <span>Larger</span>
                    </div>
                </div>
            </div>
            </div>
        </details>

        <div class="card">
            <h3 style="margin-bottom: var(--spacing-md);">Generate QR Code</h3>

            <!-- Validation Status Card -->
            <div class="validation-status-card" role="status" aria-live="polite">
                <div class="validation-row">
                    <span id="contentLengthIndicator">‚úÖ 0 / 4,296 characters</span>
                    <span id="urlValidationIndicator">‚è∏Ô∏è Waiting for content...</span>
                </div>
                <div class="validation-row">
                    <span id="scanDifficultyIndicator">‚úÖ Scan difficulty: Easy</span>
                    <span id="contrastStatusIndicator">üé® Contrast: Not set</span>
                </div>
            </div>

            <!-- Keyboard Shortcuts Hint -->
            <div class="keyboard-hints" role="note" style="margin-bottom: var(--spacing-sm); padding: var(--spacing-xs); background: var(--bg-secondary); border-radius: var(--radius); text-align: center;">
                <small style="color: var(--text-secondary);">
                    üí° <strong>Tip:</strong> Press <kbd>Enter</kbd> to generate ‚Ä¢ <kbd>Ctrl+S</kbd> to download ‚Ä¢ <kbd>/</kbd> to search tools
                </small>
            </div>

            <button class="btn btn-primary" id="generateBtn" onclick="generateQR()"
                    aria-label="Generate QR code from entered content"
                    style="width: 100%; padding: 18px; font-size: 1.1rem; font-weight: 700;">
                ‚ú® Generate QR Code
            </button>
            <div id="message" class="message" style="margin-top: var(--spacing-sm);" role="alert" aria-live="assertive"></div>
        </div>

        <!-- Screen reader announcements -->
        <div id="sr-announcements" class="sr-only" role="status" aria-live="polite" aria-atomic="true"></div>

        <div id="resultSection" class="card" role="region" aria-labelledby="resultHeading" style="display: none;">
            <h3 id="resultHeading" style="margin-bottom: var(--spacing-md);">Your QR Code</h3>

            <div class="qr-container">
                <div class="qr-display">
                    <div id="qrPlaceholder" class="qr-placeholder">Click "Generate QR Code" to create</div>
                    <canvas id="qrcode" class="hidden" role="img" aria-label="Generated QR code"></canvas>
                </div>
            </div>

            <!-- Download Toolbar -->
            <div class="download-toolbar">
                <div style="display: flex; align-items: center; gap: var(--spacing-xs); flex: 1; min-width: 200px;">
                    <label style="font-weight: bold; white-space: nowrap;">Filename:</label>
                    <input type="text" id="qrFilename" placeholder="qrcode" value="qrcode" style="flex: 1; min-width: 100px;">
                </div>

                <div class="download-actions">
                    <button class="btn" onclick="downloadQR()"
                            aria-label="Download QR code as PNG image"
                            style="min-height: 44px;">üì• PNG</button>
                    <button class="btn" onclick="downloadSVG()"
                            aria-label="Download QR code as SVG vector"
                            style="min-height: 44px;">üìê SVG</button>
                    <button class="btn" onclick="downloadPDF()"
                            aria-label="Download QR code as PDF document"
                            style="min-height: 44px;">üìÑ PDF</button>
                    <button class="btn btn-primary" onclick="downloadAllFormats()"
                            aria-label="Download QR code in all formats as ZIP file"
                            style="min-height: 44px; font-weight: 700;">üì¶ All (ZIP)</button>
                    <button class="btn btn-secondary" onclick="copyQR()"
                            aria-label="Copy QR code image to clipboard"
                            style="min-height: 44px;">üìã Copy</button>
                </div>
            </div>
        </div>

        <details class="card" id="historySection" style="margin-top: var(--spacing-lg);">
            <summary style="cursor: pointer; font-weight: bold; font-size: 1.1rem; padding: var(--spacing-sm); background: var(--bg-secondary); border-radius: var(--radius); user-select: none; display: flex; justify-content: space-between; align-items: center;"
                     aria-label="Recent QR codes history">
                <span id="historyHeader">üìö Recent QR Codes (0)</span>
                <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); clearHistory();"
                        aria-label="Clear all history"
                        style="font-size: 0.875rem; padding: 0.25rem 0.75rem;">Clear All</button>
            </summary>
            <div id="historyContainer"
                 role="region"
                 aria-label="QR code history items"
                 style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-md);">
                <p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1; margin: var(--spacing-md) 0;">No recent QR codes yet. Generate your first QR code to see it here!</p>
            </div>
        </details>

        <!-- Related Tools -->
        <div class="related-tools">
            <h3>Related Tools</h3>
            <div class="related-tools-grid">
                <a href="base64-encoder.html" class="related-tool-card">
                    <span class="related-tool-icon">B64</span>
                    <span class="related-tool-name">Base64 Encoder</span>
                </a>
                <a href="url-encoder.html" class="related-tool-card">
                    <span class="related-tool-icon">%</span>
                    <span class="related-tool-name">URL Encoder</span>
                </a>
                <a href="uuid-generator.html" class="related-tool-card">
                    <span class="related-tool-icon">ID</span>
                    <span class="related-tool-name">UUID Generator</span>
                </a>
            </div>
        </div>

        <div class="info-section">
            <h2>About QR Code Generator</h2>
            <p>QR (Quick Response) codes are 2D barcodes that encode information in a visual pattern readable by smartphones and barcode scanners. Created in 1994, QR codes have become ubiquitous for marketing, product tracking, event management, and data sharing. This tool generates professional QR codes instantly with customization options and instant download capabilities. Perfect for businesses, marketers, developers, and anyone needing to share data through scannable codes.</p>

            <h3>Key Features</h3>
            <ul>
                <li><strong>Multiple QR Types:</strong> Text/URL, vCard (contacts), WiFi credentials, Email, SMS</li>
                <li><strong>Logo Upload:</strong> Add your brand logo to QR codes with adjustable size (10-40%)</li>
                <li><strong>Gradient Colors:</strong> Linear and radial gradients for eye-catching designs</li>
                <li><strong>Module Patterns:</strong> Choose from squares, dots, or rounded shapes</li>
                <li><strong>Vector Downloads:</strong> Export as SVG, PDF, or PNG for print and web</li>
                <li><strong>Flexible Sizes:</strong> Generate codes from 128x128 to 2048x2048 pixels</li>
                <li><strong>Error Correction:</strong> Choose Low (7%), Medium (15%), Quartile (25%), or High (30%)</li>
                <li><strong>Color Customization:</strong> Full control over foreground and background colors</li>
                <li><strong>Clipboard Copy:</strong> Copy QR code image directly to clipboard</li>
                <li><strong>WiFi QR Codes:</strong> Generate scannable WiFi credentials (WPA/WPA2/WEP/Open)</li>
                <li><strong>vCard QR Codes:</strong> Create digital business cards with contact info</li>
                <li><strong>100% Private:</strong> All processing happens in your browser‚Äîno data uploaded</li>
            </ul>

            <h3>How to Use This Tool</h3>

            <p><strong>Step 1: Enter Content</strong></p>
            <ol>
                <li>Paste or type the content you want to encode (URL, text, contact info, etc.)</li>
                <li>Content can be up to 4,296 characters</li>
            </ol>

            <p><strong>Step 2: Customize (Optional)</strong></p>
            <ol>
                <li>Choose QR code size (128x128, 256x256, or 512x512 pixels)</li>
                <li>Pick colors‚Äîclick color boxes to customize foreground and background</li>
                <li>Keep high contrast for reliable scanning</li>
            </ol>

            <p><strong>Step 3: Generate & Download</strong></p>
            <ol>
                <li>Click "Generate QR Code" to create your code</li>
                <li>Click "Download PNG" to save or "Copy to Clipboard" to use immediately</li>
            </ol>

            <p><em>Pro tip: Always test your QR code with a smartphone camera before distribution to ensure it scans properly.</em></p>

            <h3>Common Use Cases</h3>

            <p><strong>Marketing & Advertising Campaigns</strong></p>
            <p>Print QR codes on flyers, billboards, business cards, and packaging to direct customers to websites, promotional pages, or discount coupons. Track engagement by using unique QR codes for each campaign.</p>

            <p><strong>WiFi Network Sharing</strong></p>
            <p>Generate QR codes for WiFi credentials‚Äîguests can scan to connect instantly without typing passwords. Reduce support calls and improve user experience.</p>

            <p><strong>Event Management & Ticketing</strong></p>
            <p>Create QR codes for event tickets, attendee check-in, or registration links. Scannable codes speed up entry and improve security.</p>

            <p><strong>Product Tracking & Inventory</strong></p>
            <p>Encode product IDs, serial numbers, or tracking URLs in QR codes for supply chain management, inventory tracking, and authenticity verification.</p>

            <h3>Tips & Best Practices</h3>
            <ul>
                <li><strong>Maintain contrast:</strong> Use dark codes on light backgrounds or vice versa. Avoid similar colors</li>
                <li><strong>Size appropriately:</strong> Larger codes for distance viewing, smaller for close range. Minimum 2cm x 2cm for reliable scanning</li>
                <li><strong>Test before distribution:</strong> Scan with multiple devices to ensure functionality</li>
                <li><strong>Keep data concise:</strong> Shorter content = smaller, faster-scanning codes</li>
                <li><strong>Avoid overlays:</strong> Don't place logos or images over the timing patterns</li>
                <li><strong>Use HTTPS URLs:</strong> Direct to secure websites for maximum trust</li>
            </ul>

            <h3>Frequently Asked Questions</h3>

            <p><strong>Q: What error correction levels are available for QR codes?</strong></p>
            <p>A: QR codes support four error correction levels: L (7% recovery), M (15% recovery), Q (25% recovery), H (30% recovery). Higher levels can restore more data if the QR code is damaged, faded, or partially obscured, but require more space and are harder to scan. This tool uses Level M (15%) which balances data capacity with robustness for most applications. Choose L for clean, controlled environments. Choose H for outdoor or high-wear applications.</p>

            <p><strong>Q: How much data can a QR code hold?</strong></p>
            <p>A: QR code capacity depends on version and error correction level. Maximum capacity is ~4,296 alphanumeric characters for numeric data. URLs typically hold 2,000-3,000 characters depending on error correction. QR codes automatically scale to fit data (more data = larger code). Version 1 is smallest, Version 40 is largest (177x177 modules). This tool auto-scales based on content length.</p>

            <p><strong>Q: What's the difference between different QR code versions?</strong></p>
            <p>A: QR versions (1-40) determine physical size and data capacity. Version 1 is 21x21 modules minimum; Version 40 is 177x177 modules maximum. Higher versions hold more data but create larger codes. Version 1 holds ~41 bytes, Version 40 holds ~4,296 bytes. Scanning speed increases with Version. This tool auto-selects version based on content‚Äîyou don't need to manually choose.</p>

            <p><strong>Q: Does QR code size matter for scanning?</strong></p>
            <p>A: Larger QR codes are easier to scan and more forgiving of damage or poor camera quality. Print at least 2cm x 2cm for reliable scanning. Very small codes (<1cm) may fail with smartphone cameras. Screen display requires at least 100x100 pixels. This tool lets you choose sizes (128x128 to 512x512 pixels). Adjust based on usage‚Äîlarger for outdoor or distance scanning, smaller for tight spaces.</p>

            <p><strong>Q: QR codes vs barcodes: what's the difference?</strong></p>
            <p>A: Barcodes (1D) store data in vertical lines and hold limited information (~20 characters). QR codes (2D) store data in a grid and hold vastly more information (4,000+ characters). QR codes work at angles while barcodes need to be straight. QR codes provide error correction; barcodes don't. QR codes are cheaper to produce and scan with smartphones. Use barcodes for simple product IDs; use QR codes for complex data, URLs, or WiFi credentials.</p>

            <p><strong>Q: Can I customize QR code colors and styling?</strong></p>
            <p>A: This tool lets you customize foreground (code) and background colors. Keep high contrast for reliable scanning‚Äîavoid light colors on light backgrounds. Black on white is most reliable but any high-contrast combination works. Avoid patterns or gradients which confuse scanners. Never modify the timing patterns (alternating lines). Logo overlays should be minimal and placed carefully.</p>

            <h3>QR Code Technical Specifications</h3>
            <p>QR codes use Reed-Solomon error correction to recover damaged data. The format includes version info, format info, timing patterns, alignment patterns, and finder patterns (the three corner squares). The data area holds the encoded content. Higher error correction levels reserve more space for redundancy. All QR codes follow ISO/IEC 18004 standard ensuring universal compatibility with all modern scanners and smartphones.</p>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Code Utils. All rights reserved.</p>
        <p>Free developer utilities - 100% client-side processing</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        CodeUtils.RecentTools.add({
            id: 'qr-generator',
            name: 'QR Generator',
            url: 'qr-generator.html'
        });

        CodeUtils.Message.init('message');

        let qrGenerated = false;
        let currentQR = null;
        let currentSettings = {};
        let logoImage = null;

        // Update logo size display
        document.getElementById('logoSize').addEventListener('input', function(e) {
            document.getElementById('logoSizeValue').textContent = e.target.value + '%';
        });

        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                CodeUtils.Message.warning('Logo file should be under 2MB for best results');
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    logoImage = img;

                    // Show preview
                    const preview = document.getElementById('logoPreview');
                    const placeholder = document.getElementById('logoPlaceholder');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    placeholder.style.display = 'none';

                    // Show logo controls
                    document.getElementById('logoSizeControl').style.display = 'block';
                    document.getElementById('clearLogoBtn').style.display = 'inline-block';

                    CodeUtils.Message.success('Logo loaded! Click "Generate QR Code" to apply.');
                    announceToScreenReader('Logo image loaded successfully', 'polite');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function clearLogo() {
            logoImage = null;
            document.getElementById('logoUpload').value = '';

            // Hide preview
            const preview = document.getElementById('logoPreview');
            const placeholder = document.getElementById('logoPlaceholder');
            preview.style.display = 'none';
            preview.src = '';
            placeholder.style.display = 'block';

            // Hide logo controls
            document.getElementById('logoSizeControl').style.display = 'none';
            document.getElementById('clearLogoBtn').style.display = 'none';

            CodeUtils.Message.success('Logo cleared');
            announceToScreenReader('Logo removed', 'polite');
        }

        // History Management
        const HISTORY_KEY = 'qr-generator-history';
        const MAX_HISTORY = 15;

        function saveToHistory(settings) {
            try {
                let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

                // Add timestamp and preview
                settings.timestamp = Date.now();
                settings.preview = document.getElementById('qrcode').toDataURL('image/png');

                // Add to beginning of array
                history.unshift(settings);

                // Keep only last MAX_HISTORY items
                if (history.length > MAX_HISTORY) {
                    history = history.slice(0, MAX_HISTORY);
                }

                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                loadHistory();
                updateHistoryHeader();
            } catch (e) {
                console.error('Failed to save to history:', e);
            }
        }

        function loadHistory() {
            try {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                const container = document.getElementById('historyContainer');
                updateHistoryHeader();

                if (history.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1; margin: var(--spacing-md) 0;">No recent QR codes yet. Generate your first QR code to see it here!</p>';
                    return;
                }

                container.innerHTML = history.map((item, index) => `
                    <div class="history-item" onclick="loadFromHistory(${index})" style="cursor: pointer; border: 1px solid var(--border); border-radius: var(--radius); padding: var(--spacing-sm); transition: all 0.2s;">
                        <img src="${item.preview}" alt="QR Code" style="width: 100%; height: auto; border-radius: var(--radius); margin-bottom: var(--spacing-xs);">
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${getQRTypeLabel(item.qrType)}">${getQRTypeLabel(item.qrType)}</div>
                            <div>${new Date(item.timestamp).toLocaleDateString()}</div>
                        </div>
                    </div>
                `).join('');

                // Add hover effect via CSS
                const style = document.createElement('style');
                style.textContent = '.history-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }';
                if (!document.getElementById('history-styles')) {
                    style.id = 'history-styles';
                    document.head.appendChild(style);
                }
            } catch (e) {
                console.error('Failed to load history:', e);
            }
        }

        function getQRTypeLabel(type) {
            const labels = {
                'text': 'Text/URL',
                'vcard': 'vCard',
                'wifi': 'WiFi',
                'email': 'Email',
                'sms': 'SMS',
                'phone': 'Phone',
                'event': 'Event',
                'location': 'Location'
            };
            return labels[type] || 'QR Code';
        }

        function loadFromHistory(index) {
            try {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                const item = history[index];
                if (!item) return;

                // Restore all settings
                document.getElementById('qrType').value = item.qrType || 'text';
                toggleQRTypeInputs();

                // Restore type-specific content
                if (item.qrType === 'text') {
                    document.getElementById('contentInput').value = item.content || '';
                }
                // Add other types as needed

                // Restore visual settings
                document.getElementById('sizeSelect').value = item.size || '256';
                document.getElementById('errorCorrection').value = item.errorCorrection || 'M';
                document.getElementById('colorType').value = item.colorType || 'solid';
                document.getElementById('fgColor').value = item.fgColor || '#000000';
                document.getElementById('fgColor2').value = item.fgColor2 || '#3498db';
                document.getElementById('bgColor').value = item.bgColor || '#ffffff';
                document.getElementById('moduleStyle').value = item.moduleStyle || 'square';

                toggleGradientControls();
                CodeUtils.Message.success('Settings loaded from history! Click "Generate QR Code" to recreate.');

                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                console.error('Failed to load from history:', e);
                CodeUtils.Message.error('Failed to load settings from history');
            }
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear all QR code history?')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistory();
                updateHistoryHeader();
                CodeUtils.Message.success('History cleared');
                announceToScreenReader('QR code history cleared', 'assertive');
            }
        }

        // Simple/Advanced Mode Toggle
        const MODE_KEY = 'qr-generator-mode';

        function setMode(mode) {
            localStorage.setItem(MODE_KEY, mode);
            const panel = document.getElementById('customizationPanel');
            const simpleModeBtn = document.getElementById('simpleModeBtn');
            const advancedModeBtn = document.getElementById('advancedModeBtn');
            const modeDescription = document.getElementById('modeDescription');

            if (mode === 'simple') {
                // Simple mode: Hide customization panel
                panel.style.display = 'none';
                simpleModeBtn.className = 'btn btn-sm';
                advancedModeBtn.className = 'btn btn-sm btn-outline';
                modeDescription.textContent = '‚ö° Simple mode active: Just enter content and generate!';
                CodeUtils.Message.success('Simple mode activated - focusing on essentials');
            } else {
                // Advanced mode: Show customization panel
                panel.style.display = 'block';
                panel.open = true;
                simpleModeBtn.className = 'btn btn-sm btn-outline';
                advancedModeBtn.className = 'btn btn-sm';
                modeDescription.textContent = '‚öôÔ∏è Advanced mode active: Full customization available!';
                CodeUtils.Message.success('Advanced mode activated - all options available');
            }

            // Announce to screen readers
            announceToScreenReader(`${mode === 'simple' ? 'Simple' : 'Advanced'} mode activated`, 'polite');
        }

        function initializeMode() {
            const savedMode = localStorage.getItem(MODE_KEY) || 'simple';
            const simpleModeBtn = document.getElementById('simpleModeBtn');
            const advancedModeBtn = document.getElementById('advancedModeBtn');
            const panel = document.getElementById('customizationPanel');
            const modeDescription = document.getElementById('modeDescription');

            if (savedMode === 'simple') {
                panel.style.display = 'none';
                simpleModeBtn.className = 'btn btn-sm';
                advancedModeBtn.className = 'btn btn-sm btn-outline';
                modeDescription.textContent = '‚ö° Simple mode: Just enter content and generate!';
            } else {
                panel.style.display = 'block';
                panel.open = true;
                simpleModeBtn.className = 'btn btn-sm btn-outline';
                advancedModeBtn.className = 'btn btn-sm';
                modeDescription.textContent = '‚öôÔ∏è Advanced mode: Full customization available!';
            }
        }

        // Screen reader announcements
        function announceToScreenReader(message, priority = 'polite') {
            const announcer = document.getElementById('sr-announcements');
            if (announcer) {
                announcer.setAttribute('aria-live', priority);
                announcer.textContent = message;
                // Clear after 3 seconds
                setTimeout(() => {
                    announcer.textContent = '';
                }, 3000);
            }
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Enter key on content input - generate QR
                if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
                    const activeElement = document.activeElement;
                    // Only if focused on content input (not other textareas)
                    if (activeElement && activeElement.id === 'contentInput') {
                        e.preventDefault();
                        generateQR();
                        announceToScreenReader('Generating QR code', 'assertive');
                    }
                }

                // Ctrl+S or Cmd+S - Download QR (prevent default save)
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (qrGenerated) {
                        downloadQR();
                        announceToScreenReader('Downloading QR code as PNG', 'assertive');
                    } else {
                        CodeUtils.Message.warning('Please generate a QR code first');
                        announceToScreenReader('No QR code to download. Please generate one first.', 'assertive');
                    }
                }

                // Ctrl+G or Cmd+G - Quick generate
                if ((e.ctrlKey || e.metaKey) && e.key === 'g') {
                    e.preventDefault();
                    generateQR();
                    announceToScreenReader('Generating QR code', 'assertive');
                }

                // Escape key - Close any open modals/dropdowns
                if (e.key === 'Escape') {
                    const dropdown = document.getElementById('allPresetsDropdown');
                    if (dropdown && dropdown.style.display !== 'none') {
                        hideAllPresets();
                    }
                }
            });
        }

        // Update loadHistory to show count
        function updateHistoryHeader() {
            try {
                const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                const count = history.length;
                const header = document.getElementById('historyHeader');
                if (header) {
                    header.textContent = `üìö Recent QR Codes (${count})`;
                }

                // Auto-expand if there are items (for first-time users after first generation)
                const historySection = document.getElementById('historySection');
                if (historySection && count > 0 && !historySection.hasAttribute('data-user-toggled')) {
                    // Don't auto-expand, let user discover
                }
            } catch (e) {
                console.error('Failed to update history header:', e);
            }
        }

        // Load history on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            validateInput();
            checkContrast();
            initializeMode(); // Initialize Simple/Advanced mode
            setupKeyboardShortcuts();
            updateHistoryHeader();

            // Track when user manually toggles history
            const historySection = document.getElementById('historySection');
            if (historySection) {
                historySection.addEventListener('toggle', () => {
                    historySection.setAttribute('data-user-toggled', 'true');
                });
            }
        });

        // Input Validation - Updated for new status card
        function validateInput() {
            const content = document.getElementById('contentInput').value;

            // Update individual indicators
            const lengthIndicator = document.getElementById('contentLengthIndicator');
            const urlIndicator = document.getElementById('urlValidationIndicator');
            const scanIndicator = document.getElementById('scanDifficultyIndicator');

            if (!lengthIndicator || !urlIndicator || !scanIndicator) return;

            // Length indicator with threshold warnings
            const length = content.length;
            const maxLength = 4296;
            const lengthPercent = (length / maxLength) * 100;
            let lengthColor = 'var(--success)';
            let lengthIcon = '‚úÖ';
            let lengthWarning = '';

            if (lengthPercent > 80 && lengthPercent <= 95) {
                lengthColor = 'var(--warning)';
                lengthIcon = '‚ö†Ô∏è';
                lengthWarning = ' (Approaching limit)';
            } else if (lengthPercent > 95) {
                lengthColor = 'var(--error)';
                lengthIcon = '‚ùå';
                lengthWarning = ' (Near maximum!)';
            }

            lengthIndicator.innerHTML = `<span style="color: ${lengthColor};">${lengthIcon} ${length} / ${maxLength} characters${lengthWarning}</span>`;

            // URL validation with better status indicators
            if (content.trim()) {
                try {
                    new URL(content.trim());
                    urlIndicator.innerHTML = '<span style="color: var(--success);">‚úÖ Valid URL</span>';
                } catch {
                    if (content.includes('http')) {
                        urlIndicator.innerHTML = '<span style="color: var(--warning);">‚ö†Ô∏è Invalid URL format</span>';
                    } else {
                        urlIndicator.innerHTML = '<span style="color: var(--text-secondary);">üìù Text content</span>';
                    }
                }
            } else {
                urlIndicator.innerHTML = '<span style="color: var(--text-secondary);">‚è∏Ô∏è Waiting for content...</span>';
            }

            // Scanning difficulty with clearer indicators
            let difficulty = 'Easy';
            let difficultyColor = 'var(--success)';
            let difficultyIcon = '‚úÖ';
            if (length > 1000) {
                difficulty = 'Medium';
                difficultyColor = 'var(--warning)';
                difficultyIcon = '‚ö†Ô∏è';
            }
            if (length > 2500) {
                difficulty = 'Hard';
                difficultyColor = 'var(--error)';
                difficultyIcon = '‚ùå';
            }
            scanIndicator.innerHTML = `<span style="color: ${difficultyColor};">${difficultyIcon} Scan difficulty: ${difficulty}</span>`;

            // Also update old validation status if it exists (for backwards compatibility)
            const oldStatusDiv = document.getElementById('validationStatus');
            if (oldStatusDiv) {
                oldStatusDiv.style.display = 'none';
            }
        }

        function checkContrast() {
            const fgColor = document.getElementById('fgColor').value;
            const bgColor = document.getElementById('bgColor').value;

            // Update both old and new indicators
            const oldIndicator = document.getElementById('contrastIndicator');
            const newIndicator = document.getElementById('contrastStatusIndicator');

            const ratio = getContrastRatio(fgColor, bgColor);

            let message, shortMessage, color, bgStyle;
            if (ratio >= 7) {
                message = `‚úì Excellent contrast (${ratio.toFixed(1)}:1) - Perfect for scanning`;
                shortMessage = `‚úì Excellent (${ratio.toFixed(1)}:1)`;
                color = 'var(--success)';
                bgStyle = 'rgba(34, 197, 94, 0.1)';
            } else if (ratio >= 4.5) {
                message = `‚úì Good contrast (${ratio.toFixed(1)}:1) - Suitable for most uses`;
                shortMessage = `‚úì Good (${ratio.toFixed(1)}:1)`;
                color = 'var(--success)';
                bgStyle = 'rgba(34, 197, 94, 0.1)';
            } else if (ratio >= 3) {
                message = `‚ö† Fair contrast (${ratio.toFixed(1)}:1) - May be difficult to scan`;
                shortMessage = `‚ö† Fair (${ratio.toFixed(1)}:1)`;
                color = 'var(--warning)';
                bgStyle = 'rgba(251, 146, 60, 0.1)';
            } else {
                message = `‚ùå Poor contrast (${ratio.toFixed(1)}:1) - QR code may not scan!`;
                shortMessage = `‚ùå Poor (${ratio.toFixed(1)}:1)`;
                color = 'var(--error)';
                bgStyle = 'rgba(239, 68, 68, 0.1)';
            }

            // Update old indicator (in customization section)
            if (oldIndicator) {
                oldIndicator.style.color = color;
                oldIndicator.style.background = bgStyle;
                oldIndicator.innerHTML = message;
            }

            // Update new indicator (in status card)
            if (newIndicator) {
                newIndicator.innerHTML = `<span style="color: ${color};">üé® ${shortMessage}</span>`;
            }
        }

        function getContrastRatio(color1, color2) {
            const l1 = getLuminance(color1);
            const l2 = getLuminance(color2);
            const lighter = Math.max(l1, l2);
            const darker = Math.min(l1, l2);
            return (lighter + 0.05) / (darker + 0.05);
        }

        function getLuminance(hex) {
            const rgb = hexToRgb(hex);
            const [r, g, b] = [rgb.r, rgb.g, rgb.b].map(val => {
                val = val / 255;
                return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        function toggleQRTypeInputs() {
            const qrType = document.getElementById('qrType').value;
            document.getElementById('textInput').style.display = qrType === 'text' ? 'block' : 'none';
            document.getElementById('vcardInput').style.display = qrType === 'vcard' ? 'block' : 'none';
            document.getElementById('wifiInput').style.display = qrType === 'wifi' ? 'block' : 'none';
            document.getElementById('emailInput').style.display = qrType === 'email' ? 'block' : 'none';
            document.getElementById('smsInput').style.display = qrType === 'sms' ? 'block' : 'none';
            document.getElementById('phoneInput').style.display = qrType === 'phone' ? 'block' : 'none';
            document.getElementById('eventInput').style.display = qrType === 'event' ? 'block' : 'none';
            document.getElementById('locationInput').style.display = qrType === 'location' ? 'block' : 'none';
        }

        // Load example data for quick testing
        function loadExample(type) {
            const qrTypeSelect = document.getElementById('qrType');

            if (type === 'url') {
                qrTypeSelect.value = 'text';
                toggleQRTypeInputs();
                document.getElementById('contentInput').value = 'https://codeutils.org';
                validateInput();
                CodeUtils.Message.success('Example URL loaded! Click "Generate QR Code" to create.');
            } else if (type === 'vcard') {
                qrTypeSelect.value = 'vcard';
                toggleQRTypeInputs();
                document.getElementById('vcardName').value = 'John Doe';
                document.getElementById('vcardPhone').value = '+1-555-0123';
                document.getElementById('vcardEmail').value = 'john.doe@example.com';
                document.getElementById('vcardOrg').value = 'Code Utils';
                document.getElementById('vcardTitle').value = 'Developer';
                document.getElementById('vcardUrl').value = 'https://codeutils.org';
                CodeUtils.Message.success('Example vCard loaded! Click "Generate QR Code" to create.');
            } else if (type === 'wifi') {
                qrTypeSelect.value = 'wifi';
                toggleQRTypeInputs();
                document.getElementById('wifiSSID').value = 'MyWiFiNetwork';
                document.getElementById('wifiPassword').value = 'SecurePassword123';
                document.getElementById('wifiEncryption').value = 'WPA';
                CodeUtils.Message.success('Example WiFi loaded! Click "Generate QR Code" to create.');
            } else if (type === 'email') {
                qrTypeSelect.value = 'email';
                toggleQRTypeInputs();
                document.getElementById('emailAddress').value = 'contact@codeutils.org';
                document.getElementById('emailSubject').value = 'Hello from Code Utils';
                document.getElementById('emailBody').value = 'This is an example email generated from a QR code.';
                CodeUtils.Message.success('Example email loaded! Click "Generate QR Code" to create.');
            }

            // Scroll smoothly to show the loaded form
            setTimeout(() => {
                const visibleSection = document.querySelector('.card[style*="display: block"], .card:not([style*="display: none"])');
                if (visibleSection && visibleSection.offsetTop) {
                    window.scrollTo({ top: visibleSection.offsetTop - 100, behavior: 'smooth' });
                }
            }, 100);
        }

        function buildQRContent() {
            const qrType = document.getElementById('qrType').value;

            if (qrType === 'vcard') {
                const name = document.getElementById('vcardName').value.trim();
                const phone = document.getElementById('vcardPhone').value.trim();
                const email = document.getElementById('vcardEmail').value.trim();
                const org = document.getElementById('vcardOrg').value.trim();
                const title = document.getElementById('vcardTitle').value.trim();
                const url = document.getElementById('vcardUrl').value.trim();

                if (!name) {
                    CodeUtils.Message.error('Name is required for vCard');
                    return null;
                }

                let vcard = 'BEGIN:VCARD\nVERSION:3.0\n';
                vcard += `FN:${name}\n`;
                vcard += `N:${name};;;\n`;
                if (phone) vcard += `TEL:${phone}\n`;
                if (email) vcard += `EMAIL:${email}\n`;
                if (org) vcard += `ORG:${org}\n`;
                if (title) vcard += `TITLE:${title}\n`;
                if (url) vcard += `URL:${url}\n`;
                vcard += 'END:VCARD';
                return vcard;

            } else if (qrType === 'wifi') {
                const ssid = document.getElementById('wifiSSID').value.trim();
                const password = document.getElementById('wifiPassword').value.trim();
                const encryption = document.getElementById('wifiEncryption').value;
                const hidden = document.getElementById('wifiHidden').checked ? 'true' : 'false';

                if (!ssid) {
                    CodeUtils.Message.error('SSID is required for WiFi');
                    return null;
                }

                let wifi = `WIFI:T:${encryption};S:${ssid};`;
                if (password && encryption !== 'nopass') wifi += `P:${password};`;
                wifi += `H:${hidden};;`;
                return wifi;

            } else if (qrType === 'email') {
                const toEl = document.getElementById('emailTo');
                const subjectEl = document.getElementById('emailSubject');
                const bodyEl = document.getElementById('emailBody');

                if (!toEl || !subjectEl || !bodyEl) {
                    CodeUtils.Message.error('Email input fields not found');
                    return null;
                }

                const to = toEl.value.trim();
                const subject = subjectEl.value.trim();
                const body = bodyEl.value.trim();

                // Debug logging
                console.log('Email fields:', { to, subject, body });

                if (!to) {
                    CodeUtils.Message.error('Email address is required. Please enter an email address.');
                    return null;
                }

                let mailto = `mailto:${to}`;
                const params = [];
                if (subject) params.push(`subject=${encodeURIComponent(subject)}`);
                if (body) params.push(`body=${encodeURIComponent(body)}`);
                if (params.length > 0) mailto += '?' + params.join('&');
                return mailto;

            } else if (qrType === 'sms') {
                const phoneEl = document.getElementById('smsPhone');
                const messageEl = document.getElementById('smsMessage');

                if (!phoneEl || !messageEl) {
                    CodeUtils.Message.error('SMS input fields not found');
                    return null;
                }

                const phone = phoneEl.value.trim();
                const message = messageEl.value.trim();

                if (!phone) {
                    CodeUtils.Message.error('Phone number is required for SMS');
                    return null;
                }

                let sms = `sms:${phone}`;
                if (message) sms += `?body=${encodeURIComponent(message)}`;
                return sms;

            } else if (qrType === 'phone') {
                const phoneEl = document.getElementById('phoneNumber');

                if (!phoneEl) {
                    CodeUtils.Message.error('Phone input field not found');
                    return null;
                }

                const phone = phoneEl.value.trim();

                if (!phone) {
                    CodeUtils.Message.error('Phone number is required');
                    return null;
                }

                return `tel:${phone}`;

            } else if (qrType === 'event') {
                const nameEl = document.getElementById('eventName');
                const startEl = document.getElementById('eventStart');
                const endEl = document.getElementById('eventEnd');
                const locationEl = document.getElementById('eventLocation');
                const descEl = document.getElementById('eventDescription');

                if (!nameEl || !startEl) {
                    CodeUtils.Message.error('Event input fields not found');
                    return null;
                }

                const name = nameEl.value.trim();
                const start = startEl.value;
                const end = endEl ? endEl.value : '';
                const location = locationEl ? locationEl.value.trim() : '';
                const description = descEl ? descEl.value.trim() : '';

                if (!name || !start) {
                    CodeUtils.Message.error('Event name and start date/time are required');
                    return null;
                }

                // Convert to iCal format
                const formatDateTime = (dt) => {
                    if (!dt) return '';
                    return new Date(dt).toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
                };

                let ical = 'BEGIN:VEVENT\n';
                ical += `SUMMARY:${name}\n`;
                ical += `DTSTART:${formatDateTime(start)}\n`;
                if (end) ical += `DTEND:${formatDateTime(end)}\n`;
                if (location) ical += `LOCATION:${location}\n`;
                if (description) ical += `DESCRIPTION:${description}\n`;
                ical += 'END:VEVENT';

                return ical;

            } else if (qrType === 'location') {
                const latEl = document.getElementById('locationLat');
                const lngEl = document.getElementById('locationLng');
                const addressEl = document.getElementById('locationAddress');

                if (!latEl || !lngEl || !addressEl) {
                    CodeUtils.Message.error('Location input fields not found');
                    return null;
                }

                const lat = latEl.value.trim();
                const lng = lngEl.value.trim();
                const address = addressEl.value.trim();

                if (lat && lng) {
                    // Use geo: protocol for coordinates
                    return `geo:${lat},${lng}`;
                } else if (address) {
                    // Use Google Maps URL for address
                    return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                } else {
                    CodeUtils.Message.error('Please enter either coordinates or an address');
                    return null;
                }

            } else {
                // Text/URL
                const contentEl = document.getElementById('contentInput');
                if (!contentEl) {
                    CodeUtils.Message.error('Content input field not found');
                    return null;
                }
                const content = contentEl.value.trim();
                if (!content) {
                    CodeUtils.Message.error('Please enter some content');
                    return null;
                }
                return content;
            }
        }

        function toggleGradientControls() {
            const colorType = document.getElementById('colorType').value;
            const fgColor2Group = document.getElementById('fgColor2Group');
            fgColor2Group.style.display = colorType !== 'solid' ? 'block' : 'none';
        }

        function showAllPresets() {
            document.getElementById('allPresetsDropdown').style.display = 'block';
        }

        function hideAllPresets() {
            document.getElementById('allPresetsDropdown').style.display = 'none';
            document.getElementById('colorPreset').value = '';
        }

        function applyPresetDirect(presetName) {
            const presets = {
                // Professional
                'classic': { fg: '#000000', fg2: '#000000', bg: '#ffffff', type: 'solid' },
                'navy': { fg: '#003366', fg2: '#003366', bg: '#ffffff', type: 'solid' },
                'corporate': { fg: '#2563eb', fg2: '#1e40af', bg: '#f3f4f6', type: 'linear' },
                'elegant': { fg: '#374151', fg2: '#374151', bg: '#ffffff', type: 'solid' },
                'professional': { fg: '#1f2937', fg2: '#1f2937', bg: '#f5f5dc', type: 'solid' },

                // Vibrant
                'sunset': { fg: '#ff6b35', fg2: '#f7931e', bg: '#ffffff', type: 'linear' },
                'ocean': { fg: '#0077be', fg2: '#00b4d8', bg: '#ffffff', type: 'linear' },
                'forest': { fg: '#2d6a4f', fg2: '#52b788', bg: '#ffffff', type: 'linear' },
                'berry': { fg: '#7209b7', fg2: '#f72585', bg: '#ffffff', type: 'linear' },
                'fire': { fg: '#dc2626', fg2: '#fb923c', bg: '#ffffff', type: 'linear' },
                'neon': { fg: '#ec4899', fg2: '#3b82f6', bg: '#000000', type: 'linear' },

                // Pastel
                'soft-pink': { fg: '#fbbf24', fg2: '#fb7185', bg: '#ffffff', type: 'linear' },
                'mint': { fg: '#6ee7b7', fg2: '#34d399', bg: '#fffbeb', type: 'linear' },
                'lavender': { fg: '#c084fc', fg2: '#e9d5ff', bg: '#ffffff', type: 'linear' },
                'peach': { fg: '#fdba74', fg2: '#fb923c', bg: '#ffffff', type: 'linear' },
                'sky': { fg: '#7dd3fc', fg2: '#38bdf8', bg: '#ffffff', type: 'linear' },

                // High Contrast
                'inverse': { fg: '#ffffff', fg2: '#ffffff', bg: '#000000', type: 'solid' },
                'yellow-black': { fg: '#fde047', fg2: '#fde047', bg: '#000000', type: 'solid' },
                'cyan-dark': { fg: '#22d3ee', fg2: '#06b6d4', bg: '#0c4a6e', type: 'linear' },
                'lime-dark': { fg: '#84cc16', fg2: '#65a30d', bg: '#14532d', type: 'linear' },
                'magenta-dark': { fg: '#e879f9', fg2: '#d946ef', bg: '#581c87', type: 'linear' },

                // Brand Colors
                'facebook': { fg: '#1877f2', fg2: '#1877f2', bg: '#ffffff', type: 'solid' },
                'instagram': { fg: '#e4405f', fg2: '#f77737', bg: '#ffffff', type: 'linear' },
                'twitter': { fg: '#1da1f2', fg2: '#1da1f2', bg: '#ffffff', type: 'solid' },
                'linkedin': { fg: '#0a66c2', fg2: '#0a66c2', bg: '#ffffff', type: 'solid' },
                'youtube': { fg: '#ff0000', fg2: '#ff0000', bg: '#ffffff', type: 'solid' }
            };

            const colors = presets[presetName];
            if (colors) {
                document.getElementById('colorType').value = colors.type;
                document.getElementById('fgColor').value = colors.fg;
                document.getElementById('fgColor2').value = colors.fg2;
                document.getElementById('bgColor').value = colors.bg;
                toggleGradientControls();
                checkContrast();
                CodeUtils.Message.success(`${presetName} preset applied!`);
                announceToScreenReader(`${presetName} color preset applied`, 'polite');
            }
        }

        function applyColorPreset() {
            const preset = document.getElementById('colorPreset').value;
            if (!preset) return;

            applyPresetDirect(preset);

            // Reset dropdown
            setTimeout(() => {
                document.getElementById('colorPreset').value = '';
            }, 1000);
        }

        // Auto-generate smart filename based on QR type and content
        function generateSmartFilename() {
            const qrType = document.getElementById('qrType').value;
            let filename = 'qrcode';

            try {
                if (qrType === 'text') {
                    const content = document.getElementById('contentInput').value.trim();
                    try {
                        const url = new URL(content);
                        // Extract domain from URL
                        const domain = url.hostname.replace('www.', '').split('.')[0];
                        filename = `qrcode-url-${domain}`;
                    } catch {
                        // Not a URL, use first 20 chars of text
                        const cleanText = content.substring(0, 20).replace(/[^a-z0-9]/gi, '-').toLowerCase();
                        filename = cleanText ? `qrcode-text-${cleanText}` : 'qrcode-text';
                    }
                } else if (qrType === 'vcard') {
                    const name = document.getElementById('vcardName').value.trim();
                    const cleanName = name.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    filename = cleanName ? `qrcode-vcard-${cleanName}` : 'qrcode-vcard';
                } else if (qrType === 'wifi') {
                    const ssid = document.getElementById('wifiSSID').value.trim();
                    const cleanSSID = ssid.replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    filename = cleanSSID ? `qrcode-wifi-${cleanSSID}` : 'qrcode-wifi';
                } else if (qrType === 'email') {
                    const email = document.getElementById('emailAddress').value.trim();
                    const cleanEmail = email.split('@')[0].replace(/[^a-z0-9]/gi, '-').toLowerCase();
                    filename = cleanEmail ? `qrcode-email-${cleanEmail}` : 'qrcode-email';
                } else if (qrType === 'sms') {
                    const phone = document.getElementById('smsNumber').value.trim().replace(/[^0-9]/g, '');
                    filename = phone ? `qrcode-sms-${phone}` : 'qrcode-sms';
                } else if (qrType === 'phone') {
                    const phone = document.getElementById('phoneNumber').value.trim().replace(/[^0-9]/g, '');
                    filename = phone ? `qrcode-phone-${phone}` : 'qrcode-phone';
                } else if (qrType === 'event') {
                    const name = document.getElementById('eventName').value.trim();
                    const cleanName = name.replace(/[^a-z0-9]/gi, '-').toLowerCase().substring(0, 20);
                    filename = cleanName ? `qrcode-event-${cleanName}` : 'qrcode-event';
                } else if (qrType === 'location') {
                    const lat = document.getElementById('locationLat').value.trim();
                    const lon = document.getElementById('locationLon').value.trim();
                    filename = (lat && lon) ? `qrcode-location-${lat}-${lon}` : 'qrcode-location';
                }
            } catch (e) {
                console.warn('Error generating smart filename:', e);
                filename = `qrcode-${qrType}`;
            }

            // Update the filename input
            document.getElementById('qrFilename').value = filename;
        }

        function generateQR() {
            // Force focus/blur to trigger autofill recognition
            const qrType = document.getElementById('qrType').value;
            if (qrType === 'email') {
                const emailTo = document.getElementById('emailTo');
                if (emailTo) {
                    emailTo.focus();
                    emailTo.blur();
                }
            }

            // Delay to ensure autofilled values are available
            setTimeout(() => {
                const content = buildQRContent();
                if (!content) {
                    return; // Error message already shown in buildQRContent
                }

                const size = parseInt(document.getElementById('sizeSelect').value);
                const errorCorrectionLevel = document.getElementById('errorCorrection').value;
                const colorType = document.getElementById('colorType').value;
                const moduleStyle = document.getElementById('moduleStyle').value;
                const fgColor = document.getElementById('fgColor').value;
                const fgColor2 = document.getElementById('fgColor2').value;
                const bgColor = document.getElementById('bgColor').value;

            try {
                // Determine QR code type/version based on content length
                const typeNumber = content.length > 100 ? 0 : 4; // 0 = auto

                const qr = qrcode(typeNumber, errorCorrectionLevel);
                qr.addData(content);
                qr.make();

                // Store for exports
                currentQR = qr;
                const logoSizePercent = logoImage ? parseInt(document.getElementById('logoSize').value) : 0;
                currentSettings = {
                    size,
                    colorType,
                    moduleStyle,
                    fgColor,
                    fgColor2,
                    bgColor,
                    hasLogo: !!logoImage,
                    logoSizePercent
                };

                const canvas = document.getElementById('qrcode');
                const moduleCount = qr.getModuleCount();
                const cellSize = Math.floor(size / moduleCount);
                const actualSize = cellSize * moduleCount;

                canvas.width = actualSize;
                canvas.height = actualSize;

                const ctx = canvas.getContext('2d');

                // Fill background
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, actualSize, actualSize);

                // Create foreground gradient or solid color
                if (colorType === 'linear') {
                    const gradient = ctx.createLinearGradient(0, 0, actualSize, actualSize);
                    gradient.addColorStop(0, fgColor);
                    gradient.addColorStop(1, fgColor2);
                    ctx.fillStyle = gradient;
                } else if (colorType === 'radial') {
                    const centerX = actualSize / 2;
                    const centerY = actualSize / 2;
                    const radius = actualSize / 2;
                    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, radius);
                    gradient.addColorStop(0, fgColor);
                    gradient.addColorStop(1, fgColor2);
                    ctx.fillStyle = gradient;
                } else {
                    ctx.fillStyle = fgColor;
                }

                // Draw QR code modules with selected style
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            const x = col * cellSize;
                            const y = row * cellSize;

                            if (moduleStyle === 'dots') {
                                // Draw circles
                                ctx.beginPath();
                                ctx.arc(x + cellSize / 2, y + cellSize / 2, cellSize / 2, 0, Math.PI * 2);
                                ctx.fill();
                            } else if (moduleStyle === 'rounded') {
                                // Draw rounded rectangles
                                const radius = cellSize * 0.3;
                                ctx.beginPath();
                                ctx.roundRect(x, y, cellSize, cellSize, radius);
                                ctx.fill();
                            } else {
                                // Draw squares (default)
                                ctx.fillRect(x, y, cellSize, cellSize);
                            }
                        }
                    }
                }

                // Draw logo overlay if present
                if (logoImage) {
                    const logoSizePercent = parseInt(document.getElementById('logoSize').value);
                    const logoSize = (actualSize * logoSizePercent) / 100;
                    const logoX = (actualSize - logoSize) / 2;
                    const logoY = (actualSize - logoSize) / 2;

                    // Draw white background circle for logo
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(actualSize / 2, actualSize / 2, logoSize / 2 + 5, 0, Math.PI * 2);
                    ctx.fill();

                    // Draw logo
                    ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
                }

                // Show canvas, hide placeholder
                document.getElementById('qrPlaceholder').classList.add('hidden');
                canvas.classList.remove('hidden');

                qrGenerated = true;

                // Show result section
                document.getElementById('resultSection').style.display = 'block';

                // Scroll to result section
                setTimeout(() => {
                    document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);

                // Auto-generate smart filename
                generateSmartFilename();

                CodeUtils.Message.success('QR code generated!');
                announceToScreenReader('QR code generated successfully. You can now download it.', 'assertive');

                // Save to history
                saveToHistory({
                    qrType: document.getElementById('qrType').value,
                    content: content,
                    size: size,
                    errorCorrection: errorCorrectionLevel,
                    colorType: colorType,
                    moduleStyle: moduleStyle,
                    fgColor: fgColor,
                    fgColor2: fgColor2,
                    bgColor: bgColor
                });
            } catch (err) {
                CodeUtils.Message.error('Failed to generate QR code: ' + err.message);
            }
            }, 150); // 150ms delay to ensure autofilled values are available
        }

        function downloadQR() {
            if (!qrGenerated) {
                CodeUtils.Message.warning('Please generate a QR code first');
                return;
            }
            const filename = (document.getElementById('qrFilename').value.trim() || 'qrcode') + '.png';
            const canvas = document.getElementById('qrcode');
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
            CodeUtils.Message.success('PNG downloaded!');
            announceToScreenReader('QR code downloaded as PNG file', 'assertive');
        }

        function downloadSVG() {
            if (!qrGenerated || !currentQR) {
                CodeUtils.Message.warning('Please generate a QR code first');
                announceToScreenReader('No QR code to download. Please generate one first.', 'assertive');
                return;
            }

            const moduleCount = currentQR.getModuleCount();
            const cellSize = Math.floor(currentSettings.size / moduleCount);
            const actualSize = cellSize * moduleCount;

            // Create SVG with gradient definitions if needed
            let svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${actualSize}" height="${actualSize}" viewBox="0 0 ${actualSize} ${actualSize}">
    <defs>`;

            let fillAttribute = `fill="${currentSettings.fgColor}"`;

            if (currentSettings.colorType === 'linear') {
                svg += `
        <linearGradient id="qrGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:${currentSettings.fgColor};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${currentSettings.fgColor2};stop-opacity:1" />
        </linearGradient>`;
                fillAttribute = 'fill="url(#qrGradient)"';
            } else if (currentSettings.colorType === 'radial') {
                svg += `
        <radialGradient id="qrGradient" cx="50%" cy="50%" r="50%">
            <stop offset="0%" style="stop-color:${currentSettings.fgColor};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${currentSettings.fgColor2};stop-opacity:1" />
        </radialGradient>`;
                fillAttribute = 'fill="url(#qrGradient)"';
            }

            svg += `
    </defs>
    <rect width="${actualSize}" height="${actualSize}" fill="${currentSettings.bgColor}"/>
    <g ${fillAttribute}>`;

            // Draw QR modules with selected style
            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (currentQR.isDark(row, col)) {
                        const x = col * cellSize;
                        const y = row * cellSize;

                        if (currentSettings.moduleStyle === 'dots') {
                            const cx = x + cellSize / 2;
                            const cy = y + cellSize / 2;
                            const r = cellSize / 2;
                            svg += `
        <circle cx="${cx}" cy="${cy}" r="${r}"/>`;
                        } else if (currentSettings.moduleStyle === 'rounded') {
                            const radius = cellSize * 0.3;
                            svg += `
        <rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" rx="${radius}" ry="${radius}"/>`;
                        } else {
                            svg += `
        <rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}"/>`;
                        }
                    }
                }
            }

            svg += `
    </g>`;

            // Add logo if present
            if (logoImage && currentSettings.hasLogo) {
                const logoSize = (actualSize * currentSettings.logoSizePercent) / 100;
                const logoX = (actualSize - logoSize) / 2;
                const logoY = (actualSize - logoSize) / 2;
                const radius = logoSize / 2 + 5;

                // Create canvas to convert logo to data URL
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = logoImage.width;
                tempCanvas.height = logoImage.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(logoImage, 0, 0);
                const logoDataURL = tempCanvas.toDataURL('image/png');

                svg += `
    <circle cx="${actualSize / 2}" cy="${actualSize / 2}" r="${radius}" fill="white"/>
    <image x="${logoX}" y="${logoY}" width="${logoSize}" height="${logoSize}" href="${logoDataURL}"/>`;
            }

            svg += `
</svg>`;

            // Download SVG
            const filename = (document.getElementById('qrFilename').value.trim() || 'qrcode') + '.svg';
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const link = document.createElement('a');
            link.download = filename;
            link.href = URL.createObjectURL(blob);
            link.click();
            URL.revokeObjectURL(link.href);
            CodeUtils.Message.success('SVG downloaded!');
            announceToScreenReader('QR code downloaded as SVG file', 'assertive');
        }

        function downloadPDF() {
            if (!qrGenerated) {
                CodeUtils.Message.warning('Please generate a QR code first');
                announceToScreenReader('No QR code to download. Please generate one first.', 'assertive');
                return;
            }

            const canvas = document.getElementById('qrcode');
            const imgData = canvas.toDataURL('image/png');

            // Create PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // Calculate dimensions to fit QR code centered on page
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const qrSize = Math.min(pageWidth - 40, pageHeight - 40, 150); // Max 150mm
            const x = (pageWidth - qrSize) / 2;
            const y = (pageHeight - qrSize) / 2;

            pdf.addImage(imgData, 'PNG', x, y, qrSize, qrSize);
            const filename = (document.getElementById('qrFilename').value.trim() || 'qrcode') + '.pdf';
            pdf.save(filename);
            CodeUtils.Message.success('PDF downloaded!');
            announceToScreenReader('QR code downloaded as PDF file', 'assertive');
        }

        async function downloadAllFormats() {
            if (!qrGenerated || !currentQR) {
                CodeUtils.Message.warning('Please generate a QR code first');
                announceToScreenReader('No QR code to download. Please generate one first.', 'assertive');
                return;
            }

            try {
                const baseFilename = document.getElementById('qrFilename').value.trim() || 'qrcode';
                const zip = new JSZip();

                // Add PNG
                const canvas = document.getElementById('qrcode');
                const pngData = canvas.toDataURL('image/png').split(',')[1];
                zip.file(`${baseFilename}.png`, pngData, { base64: true });

                // Add SVG
                const svg = generateSVGContent();
                zip.file(`${baseFilename}.svg`, svg);

                // Add PDF
                const pdfBlob = await generatePDFBlob();
                zip.file(`${baseFilename}.pdf`, pdfBlob);

                // Generate and download ZIP
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.download = `${baseFilename}-qr-codes.zip`;
                link.href = URL.createObjectURL(zipBlob);
                link.click();
                URL.revokeObjectURL(link.href);

                CodeUtils.Message.success('All formats downloaded as ZIP!');
                announceToScreenReader('QR code downloaded in all formats as ZIP file', 'assertive');
            } catch (error) {
                console.error('Batch download error:', error);
                CodeUtils.Message.error('Failed to create ZIP file');
                announceToScreenReader('Failed to create ZIP file', 'assertive');
            }
        }

        function generateSVGContent() {
            const moduleCount = currentQR.getModuleCount();
            const cellSize = Math.floor(currentSettings.size / moduleCount);
            const actualSize = cellSize * moduleCount;

            let svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="${actualSize}" height="${actualSize}" viewBox="0 0 ${actualSize} ${actualSize}">
    <defs>`;

            let fillAttribute = `fill="${currentSettings.fgColor}"`;

            if (currentSettings.colorType === 'linear') {
                svg += `
        <linearGradient id="qrGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:${currentSettings.fgColor};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${currentSettings.fgColor2};stop-opacity:1" />
        </linearGradient>`;
                fillAttribute = 'fill="url(#qrGradient)"';
            } else if (currentSettings.colorType === 'radial') {
                svg += `
        <radialGradient id="qrGradient" cx="50%" cy="50%" r="50%">
            <stop offset="0%" style="stop-color:${currentSettings.fgColor};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${currentSettings.fgColor2};stop-opacity:1" />
        </radialGradient>`;
                fillAttribute = 'fill="url(#qrGradient)"';
            }

            svg += `
    </defs>
    <rect width="${actualSize}" height="${actualSize}" fill="${currentSettings.bgColor}"/>
    <g ${fillAttribute}>`;

            for (let row = 0; row < moduleCount; row++) {
                for (let col = 0; col < moduleCount; col++) {
                    if (currentQR.isDark(row, col)) {
                        const x = col * cellSize;
                        const y = row * cellSize;

                        if (currentSettings.moduleStyle === 'dots') {
                            const cx = x + cellSize / 2;
                            const cy = y + cellSize / 2;
                            const r = cellSize / 2;
                            svg += `\n        <circle cx="${cx}" cy="${cy}" r="${r}"/>`;
                        } else if (currentSettings.moduleStyle === 'rounded') {
                            const radius = cellSize * 0.3;
                            svg += `\n        <rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}" rx="${radius}" ry="${radius}"/>`;
                        } else {
                            svg += `\n        <rect x="${x}" y="${y}" width="${cellSize}" height="${cellSize}"/>`;
                        }
                    }
                }
            }

            if (logoImage && currentSettings.hasLogo) {
                const logoSize = (actualSize * currentSettings.logoSizePercent) / 100;
                const logoX = (actualSize - logoSize) / 2;
                const logoY = (actualSize - logoSize) / 2;
                const radius = logoSize / 2 + 5;

                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = logoImage.width;
                tempCanvas.height = logoImage.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(logoImage, 0, 0);
                const logoDataURL = tempCanvas.toDataURL('image/png');

                svg += `\n    </g>\n    <circle cx="${actualSize / 2}" cy="${actualSize / 2}" r="${radius}" fill="white"/>`;
                svg += `\n    <image x="${logoX}" y="${logoY}" width="${logoSize}" height="${logoSize}" href="${logoDataURL}"/>`;
            } else {
                svg += `\n    </g>`;
            }

            svg += `\n</svg>`;
            return svg;
        }

        async function generatePDFBlob() {
            const canvas = document.getElementById('qrcode');
            const imgData = canvas.toDataURL('image/png');

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const qrSize = Math.min(pageWidth - 40, pageHeight - 40, 150);
            const x = (pageWidth - qrSize) / 2;
            const y = (pageHeight - qrSize) / 2;

            pdf.addImage(imgData, 'PNG', x, y, qrSize, qrSize);
            return pdf.output('blob');
        }

        async function copyQR() {
            if (!qrGenerated) {
                CodeUtils.Message.warning('Please generate a QR code first');
                announceToScreenReader('No QR code to copy. Please generate one first.', 'assertive');
                return;
            }
            try {
                const canvas = document.getElementById('qrcode');
                canvas.toBlob(async (blob) => {
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    CodeUtils.Message.success('QR code copied!');
                    announceToScreenReader('QR code image copied to clipboard', 'assertive');
                });
            } catch (err) {
                CodeUtils.Message.error('Failed to copy image');
                announceToScreenReader('Failed to copy image to clipboard', 'assertive');
            }
        }
    </script>
</body>
</html>
